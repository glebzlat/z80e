# Format:
#   - desc: <description>
#     source: <asm code>
#
#     # Optional: test is disabled if skip is present.
#     skip: <reason>
#
#     # Optional: Program Counter -> register dump mapping. When the PC reaches
#     #   the value in this field, the executable prints this register dump.
#     #   It is asserted to be equal to the given register values.
#     #   Registers not mentioned must be equal to 0x00.
#     #   Note that the actual PC may be greater than dump point if the point
#     #   is not aligned with the instruction bytes.
#     inspect:
#       <pc>:
#         <register-name>: <int>
#         ...
#
#     # Optional: conditions set before the program is executed.
#     preset:
#       # Optional: preset registers.
#       regs:
#         <register-name>: <int>
#         ...
#
#       # Optional: memory address -> value mapping. Set memory values at
#       #   given addresses.
#       mem:
#         <addr>: <int>
#         ...
#
#     regs:
#       # Registers not mentioned in regs must be equal to 0x00.
#       <register-name>: <int>
#       ...
#
#     # Optional: memory address -> value mapping. Given addresses
#     #   tested to be equal to given values. Addresses not present in this
#     #   field are not tested.
#     mem:
#       <addr>: <int>
#       ...

tests:
  - desc: test pipeline - preset registers
    preset:
      regs:
        a: 0x01
        b: 0x02
        c: 0x03
        d: 0x04
        e: 0x05
        f: 0x06
        h: 0x07
        l: 0x08
        a_alt: 0x11
        b_alt: 0x12
        c_alt: 0x13
        d_alt: 0x14
        e_alt: 0x15
        f_alt: 0x16
        h_alt: 0x17
        l_alt: 0x18
        i: 0x09
        r: 0x0a
        ix: 0x100b
        iy: 0x200c
        sp: 0x300e
    source: |
      halt
    regs:
      a: 0x01
      b: 0x02
      c: 0x03
      d: 0x04
      e: 0x05
      f: 0x06
      h: 0x07
      l: 0x08
      a_alt: 0x11
      b_alt: 0x12
      c_alt: 0x13
      d_alt: 0x14
      e_alt: 0x15
      f_alt: 0x16
      h_alt: 0x17
      l_alt: 0x18
      i: 0x09
      r: 0x0a
      ix: 0x100b
      iy: 0x200c
      sp: 0x300e
      pc: 0x0001

  - desc: test pipeline - preset memory
    preset:
      mem:
        0x0010: 0x88
        0x0011: 0x89
        0x0012: 0x8a
    source: |
      halt
    regs:
      pc: 0x0001
    mem:
      0x0010: 0x88
      0x0011: 0x89
      0x0012: 0x8a

  - desc: test pipeline - dump points
    inspect:
      0x0002:
        a: 0x88
        pc: 0x0002
      0x0004:
        a: 0x88
        b: 0x66
        pc: 0x0004
      0x0005:
        a: 0x88
        b: 0x66
        c: 0x33
        # Note that the dump point may not be aligned, but PC always is.
        pc: 0x0006
    source: |
      ld a, 0x88
      ld b, 0x66
      ld c, 0x33
      halt
    regs:
      a: 0x88
      b: 0x66
      c: 0x33
      pc: 0x0007

  - desc: nop
    source: |
      nop
      nop
      halt
    regs:
      pc: 0x0003
  - desc: ld a, n
    source: |
      ld a, 0x10
      halt
    regs:
      a: 0x10
      pc: 0x0003
  - desc: ld b, n
    source: |
      ld b, 0x10
      halt
    regs:
      b: 0x10
      pc: 0x0003
  - desc: ld r, r'
    source: |
      ld a, 0x10
      ld b, a
      halt
    regs:
      a: 0x10
      b: 0x10
      pc: 0x0004
  - desc: ld bc, nn
    source: |
      ld bc, 0x1020
      halt
    regs:
      b: 0x10
      c: 0x20
      pc: 0x0004
  - desc: ld (hl), n
    source: |
      ld hl, 0x0010
      ld (hl), 0xaa
      halt
    regs:
      h: 0x00
      l: 0x10
      pc: 0x0006
    mem:
      0x10: 0xaa
  - desc: ld hl, nn
    source: |
      ld hl, 0x1234
      halt
    regs:
      h: 0x12
      l: 0x34
      pc: 0x0004
  - desc: ld r, (hl);
    source: |
      ld hl, 0x1234
      ld (hl), 0x10
      ld a, (hl)
      ld b, (hl)
      ld c, (hl)
      ld d, (hl)
      ld e, (hl)
      halt
    regs:
      a: 0x10
      b: 0x10
      c: 0x10
      d: 0x10
      d: 0x10
      e: 0x10
      h: 0x12
      l: 0x34
      pc: 0x000b
  - desc: ld (hl), r
    source: |
      ld a, 0xaf
      ld hl, 0x1000
      ld (hl), a
      halt
    regs:
      a: 0xaf
      h: 0x10
      l: 0x00
      pc: 0x0007
    mem:
      0x1000: 0xaf
  - desc: ld bc, nn; ld (bc), a; ld a, (bc)
    source: |
      ld a, 0xaf
      ld bc, 0x1234
      ld (bc), a
      ld a, 0xfa
      ld a, (bc)
      halt
    regs:
      a: 0xaf
      b: 0x12
      c: 0x34
      pc: 0x000a
    mem:
      0x1234: 0xaf
  - desc: ld de, nn; ld (de), a; ld a, (de)
    source: |
      ld a, 0xaf
      ld de, 0x1234
      ld (de), a
      ld a, 0xfa
      ld a, (de)
      halt
    regs:
      a: 0xaf
      d: 0x12
      e: 0x34
      pc: 0x000a
    mem:
      0x1234: 0xaf
  - desc: ld a, (nn); ld (nn), a
    source: |
      ld a, 0x10
      ld (0x1234), a
      ld a, 0x20
      ld a, (0x1234)
      halt
    regs:
      a: 0x10
      pc: 0x000b
    mem:
      0x1234: 0x10

  - desc: ld r, (iz+d)
    preset:
      regs:
        ix: 0x0100
        iy: 0x0100
      mem:
        0x0108: 0xfa
        0x00f8: 0xed
    source: |
      ld a, (ix+8)
      ld b, (iy-8)
      halt
    regs:
      ix: 0x0100
      iy: 0x0100
      a: 0xfa
      b: 0xed
      pc: 0x0007

  - desc: ld (iz+d), r
    preset:
      regs:
        c: 0x1c
        ix: 0x3100
    source: |
      ld (ix+6), c
      halt
    regs:
      c: 0x1c
      ix: 0x3100
      pc: 0x0004

  - desc: ld (iz+d), n
    preset:
      regs:
        ix: 0x1010
    source: |
      ld (ix+1), 0x15
      halt
    regs:
      ix: 0x1010
      pc: 0x0005
    mem:
      0x1011: 0x15

  - desc: ld (nn), hl
    source: |
      ld hl, 0x1234
      ld (0x0001), hl
      halt
    regs:
      h: 0x12
      l: 0x34
      pc: 0x0007
    mem:
      0x0001: 0x34
      0x0002: 0x12

  - desc: ld sp, hl
    source: |
      ld hl, 0x1234
      ld sp, hl
      halt
    regs:
      h: 0x12
      l: 0x34
      sp: 0x1234
      pc: 0x0005

  - desc: ld iz, nn
    source: |
      ld ix, 0x1234
      ld iy, 0x4321
      halt
    regs:
      ix: 0x1234
      iy: 0x4321
      pc: 0x0009

  - desc: ld iz, (nn)
    preset:
      mem:
        0x0100: 0x20
        0x0101: 0x10
        0x0200: 0x40
        0x0201: 0x30
    source: |
      ld ix, (0x0100)
      ld iy, (0x0200)
      halt
    regs:
      ix: 0x1020
      iy: 0x3040
      pc: 0x0009

  - desc: ld (nn), iz
    preset:
      regs:
        ix: 0x1122
        iy: 0x3344
    source: |
      ld (0x0015), ix
      ld (0x0020), iy
      halt
    regs:
      ix: 0x1122
      iy: 0x3344
      pc: 0x0009
    mem:
      0x0015: 0x22
      0x0016: 0x11
      0x0020: 0x44
      0x0021: 0x33

  - desc: ld (nn), ix
    preset:
      regs:
        ix: 0x5a30
    source: |
      ld (0x4392), ix
      halt
    regs:
      ix: 0x5a30
      pc: 0x0005
    mem:
      0x4392: 0x30
      0x4393: 0x5a

  - desc: ex de, hl
    source: |
      ld hl, 0x1020
      ld de, 0x3040
      ex de, hl
      halt
    regs:
      d: 0x10
      e: 0x20
      h: 0x30
      l: 0x40
      pc: 0x0008
  - desc: exx
    source: |
      ld bc, 0x1a2a
      ld de, 0x3a4a
      ld hl, 0x5a6a
      exx
      ld bc, 0x1b2b
      ld de, 0x3b4b
      ld hl, 0x5b6b
      halt
    regs:
      b: 0x1a
      b_alt: 0x1b
      c: 0x2a
      c_alt: 0x2b
      d: 0x3a
      d_alt: 0x3b
      e: 0x4a
      e_alt: 0x4b
      h: 0x5a
      h_alt: 0x5b
      l: 0x6a
      l_alt: 0x6b
      pc: 0x0014

  - desc: ex (sp), hl
    source: |
      ld de, 0x1234
      push de
      ex (sp), hl
      halt
    regs:
      d: 0x12
      e: 0x34
      h: 0x12
      l: 0x34
      sp: 0xfffe
      pc: 0x0006

  - desc: ex (sp), ix
    preset:
      regs:
        ix: 0x3988
        sp: 0x0100
      mem:
        0x0100: 0x90
        0x0101: 0x48
    source: |
      ex (sp), ix
      halt
    regs:
      ix: 0x4890
      sp: 0x0100
      pc: 0x0003
    mem:
      0x0100: 0x88
      0x0101: 0x39

  - desc: add a, r - no flags
    source: |
      ld b, 0x1
      add a, b
      halt
    regs:
      a: 0x01
      b: 0x01
      f: 0x00
      pc: 0x0004

  - desc: add a, r - sf
    source: |
      ld b, 0x80
      add a, b
      halt
    regs:
      a: 0x80
      b: 0x80
      f: 0x80
      pc: 0x0004

  - desc: add a, r - zf
    source: |
      add a, b
      halt
    regs:
      f: 0x40
      pc: 0x0002

  - desc: add a, r - yf
    source: |
      ld a, 0x10
      ld b, 0x10
      add a, b
      halt
    regs:
      a: 0x20
      b: 0x10
      f: 0x20
      pc: 0x0006

  - desc: add a, r - hf
    source: |
      ld a, 0xd
      ld b, 0x3
      add a, b
      halt
    regs:
      a: 0x10
      b: 0x03
      f: 0x10
      pc: 0x0006

  - desc: add a, r - xf
    source: |
      ld a, 0x04
      ld b, 0x04
      add a, b
      halt
    regs:
      a: 0x08
      b: 0x04
      f: 0x08
      pc: 0x0006

  - desc: dec a
    source: |
      ld a, 0x10
      dec a
      halt
    regs:
      a: 0x0f
      f: 0x1a
      pc: 0x0004

  - desc: add a, r - pvf, cf
    source: |
      ld a, 0xff
      ld b, 2
      add a, b
      halt
    regs:
      a: 0x01
      b: 0x02
      f: 0x15
      pc: 0x0006

  - desc: add a, r - all registers
    source: |
      ld b, 0x1
      ld c, 0x2
      ld d, 0x3
      ld e, 0x4
      ld h, 0x5
      ld l, 0x6
      add a, b
      add a, c
      add a, d
      add a, e
      add a, h
      add a, l
      halt
    regs:
      a: 0x15
      b: 0x01
      c: 0x02
      d: 0x03
      e: 0x04
      h: 0x05
      l: 0x06
      f: 0x10
      pc: 0x0013

  - desc: add a, n
    source: |
      ld a, 0xff
      add a, 0x40
      halt
    regs:
      a: 0x3f
      f: 0x2d
      pc: 0x0005

  - desc: add a, (hl)
    source: |
      ld hl, 0x0100
      ld (hl), 0x08
      ld a, 0x18
      add a, (hl)
      halt
    regs:
      a: 0x20
      h: 0x01
      f: 0x30
      pc: 0x0009

  - desc: add a, n - overflow
    source: |
      ld a, 0xff
      add a, 0x11
      halt
    regs:
      a: 0x10
      f: 0x15
      pc: 0x0005

  - desc: add a, (ix+d)
    preset:
      regs:
        a: 0x11
        ix: 0x1000
      mem:
        0x1005: 0x22
    source: |
      add a, (ix+5)
      halt
    regs:
      a: 0x33
      f: 0x20
      ix: 0x1000
      pc: 0x0004

  - desc: adc a, r - cf = 1
    source: |
      ld a, 0xff
      ld b, 0x16
      add a, 0x11  ; cf = 1, a = 0x10
      adc a, b     ; a = 0x10 + 0x16 + 1 = 0x27
      halt
    regs:
      a: 0x27
      b: 0x16
      f: 0x20
      pc: 0x0008

  - desc: adc a, r - cf = 0
    source: |
      ld a, 0x10
      ld b, 0x16
      adc a, b
      halt
    regs:
      a: 0x26
      b: 0x16
      f: 0x20
      pc: 0x0006

  - desc: adc a, r - edge case
    source: |
      ld a, 0xff
      ld b, 0xff
      add a, 0x02  ; cf = 1, a = 0x01
      adc a, b     ; a = 0x01 + 0xff + 1 = 0x01
      halt
    regs:
      a: 0x01
      b: 0xff
      f: 0x15
      pc: 0x0008

  - desc: adc a, n
    source: |
      ld a, 0xff
      add a, 0x02
      adc a, 0xff
      halt
    regs:
      a: 0x01
      f: 0x15
      pc: 0x0007

  - desc: adc a, (hl)
    source: |
      ld hl, 0x0100
      ld (hl), 0x16
      ld a, 0xff
      add a, 0x11
      adc a, (hl)
      halt
    regs:
      a: 0x27
      h: 0x01
      f: 0x20
      pc: 0x000b

  - desc: adc a, (ix+d)
    preset:
      regs:
        a: 0x16
        f: 0x01
        ix: 0x001f
      mem:
        0x0026: 0x10
    source: |
      adc a, (ix+7)
      halt
    regs:
      a: 0x27
      f: 0x20
      ix: 0x001f
      pc: 0x0004

  - desc: sub r - sf, yf, hf, xf, nf, cf
    source: |
      ld b, 0x01
      sub b
      halt
    regs:
      a: 0xff
      b: 0x01
      f: 0xbf
      pc: 0x0004

  - desc: sub r - zf, nf
    source: |
      ld b, 0x01
      ld a, 0x01
      sub b
      halt
    regs:
      a: 0x00
      b: 0x01
      f: 0x42
      pc: 0x0006

  - desc: sub r - all registers
    source: |
      ld a, 0x16
      ld b, 0x01
      ld c, 0x02
      ld d, 0x03
      ld e, 0x04
      ld h, 0x05
      ld l, 0x06
      sub b
      sub c
      sub d
      sub e
      sub h
      sub l
      halt
    regs:
      a: 0x01
      b: 0x01
      c: 0x02
      d: 0x03
      e: 0x04
      h: 0x05
      l: 0x06
      f: 0x02
      pc: 0x0015

  - desc: sub n
    source: |
      ld a, 0x10
      sub 0x06
      halt
    regs:
      a: 0x0a
      f: 0x1a
      pc: 0x0005

  - desc: sub (hl)
    source: |
      ld hl, 0x1234
      ld (hl), 0x10
      ld a, 0x40
      sub (hl)
      halt
    regs:
      a: 0x30
      h: 0x12
      l: 0x34
      f: 0x22
      pc: 0x0009

  - desc: sub (iz+d)
    preset:
      regs:
        a: 0x20
        ix: 0x0100
        iy: 0x0100
      mem:
        0x00f9: 0x02
        0x0107: 0x03
    source: |
      sub (ix-7)
      sub (iy+7)
      halt
    regs:
      a: 0x1b
      f: 0x0a
      ix: 0x0100
      iy: 0x0100
      pc: 0x0007

  - desc: sbc a, r - cf = 1
    source: |
      ld b, 0x05
      sub 0xea   ; cf = 1, a = 0x16
      sbc a, b   ; a = 0x16 - (0x05 + 1) = 0x10, cf = 0
      halt
    regs:
      a: 0x10
      b: 0x05
      f: 0x02
      pc: 0x0006

  - desc: sbc a, r
    source: |
      sub 0xea  ; cf = 1, a = 0x16
      sbc a, b  ; a = 0x16 - (0x00 + 1) = 0x15, cf = 0
      halt
    regs:
      a: 0x15
      f: 0x02
      pc: 0x0004

  - desc: sbc a, r - cf = 0
    source: |
      ld b, 0x01
      sbc a, b
      halt
    regs:
      a: 0xff
      b: 0x01
      f: 0xbf
      pc: 0x0004

  - desc: sbc a, r - edge case
  # Interesting case. I expected sbc to perform a - b - 1, but what it seems sbc
  # actually does is a - (b + 1):
  #
  # > Sum of second operand and carry flag is subtracted from the first operand.
  #
  # from http://z80-heaven.wikidot.com/instructions-set:sbc
    source: |
      ld b, 0xff
      sub 0x1
      sbc a, b
      halt
    regs:
      a: 0xff
      b: 0xff
      f: 0xaa
      pc: 0x0006

  - desc: sbc a, n
    source: |
      sub 0xea
      sbc a, 0x5
      halt
    regs:
      a: 0x10
      f: 0x02
      pc: 0x0005

  - desc: sbc a, (hl)
    source: |
      ld hl, 0x1234
      ld (hl), 0xff
      sub 0x1       ; cf = 1, a = 0xff
      sbc a, (hl)   ; a = 0xff - (0xff + 1) = 0xff
      halt
    regs:
      a: 0xff
      h: 0x12
      l: 0x34
      f: 0xaa
      pc: 0x0009

  - desc: sbc a, (ix+d)
    preset:
      regs:
        a: 0x16
        f: 0x01
        ix: 0x4532
      mem:
        0x4530: 0x05
    source: |
      sbc a, (ix-2)
      halt
    regs:
      a: 0x10
      f: 0x02
      ix: 0x4532
      pc: 0x0004

  - desc: and r - hf, pf
    source: |
      ld a, 0xc3
      ld b, 0x7a
      and b
      halt
    regs:
      a: 0x42
      b: 0x7a
      f: 0x14
      pc: 0x0006

  - desc: and r - zf
    source: |
      ld a, 0x04
      ld b, 0x08
      and b
      halt
    regs:
      b: 0x08
      f: 0x54
      pc: 0x0006

  - desc: and r - sf, yf, xf
    source: |
      ld a, 0xbc
      ld b, 0xa8
      and b
      halt
    regs:
      a: 0xa8
      b: 0xa8
      f: 0xb8
      pc: 0x0006

  - desc: and n
    source: |
      ld a, 0x62
      and 0xc2
      halt
    regs:
      a: 0x42
      f: 0x14
      pc: 0x0005

  - desc: and (hl)
    source: |
      ld a, 0x7c
      ld hl, 0x0100
      ld (hl), 0xc6
      and (hl)
      halt
    regs:
      a: 0x44
      h: 0x01
      f: 0x14
      pc: 0x0009

  - desc: and (iz+d)
    preset:
      regs:
        a: 0x7b
        ix: 0x0100
        iy: 0x0100
      mem:
        0x00f2: 0x69
        0x010e: 0x38
    source: |
      and (ix+0xe)
      and (iy-0xe)
      halt
    regs:
      a: 0x28
      f: 0x3c
      ix: 0x0100
      iy: 0x0100
      pc: 0x0007

  - desc: or r - xf, pf
    source: |
      ld a, 0x12
      ld h, 0x48
      or h
      halt
    regs:
      a: 0x5a
      h: 0x48
      f: 0x0c
      pc: 0x0006
  - desc: or r - sf
    source: |
      ld a, 0x00
      ld b, 0x80
      or b
      halt
    regs:
      a: 0x80
      b: 0x80
      f: 0x80
      pc: 0x0006
  - desc: or r - zf
    source: |
      or b
      halt
    regs:
      f: 0x44
      pc: 0x0002
  - desc: or r - yf
    source: |
      ld c, 0x20
      or c
      halt
    regs:
      a: 0x20
      c: 0x20
      f: 0x20
      pc: 0x0004
  - desc: or n
    source: |
      ld a, 0xa5
      or 0x5a
      halt
    regs:
      a: 0xff
      f: 0xac
      pc: 0x0005
  - desc: or (hl)
    source: |
      ld hl, 0x0010
      ld (hl), 0x77
      or (hl)
      halt
    regs:
      a: 0x77
      l: 0x10
      f: 0x24
      pc: 0x0007
  - desc: xor r - sf, xf, pf
    source: |
      ld a, 0x96
      ld b, 0x5d
      xor b
      halt
    regs:
      a: 0xcb
      b: 0x5d
      f: 0x88
      pc: 0x0006
  - desc: xor r - zf
    source: |
      ld a, 0x60
      ld b, 0x60
      xor b
      halt
    regs:
      a: 0x00
      b: 0x60
      f: 0x44
      pc: 0x0006
  - desc: xor r - yf
    source: |
      ld a, 0x5f
      ld c, 0x7f
      xor c
      halt
    regs:
      a: 0x20
      c: 0x7f
      f: 0x20
      pc: 0x0006
  - desc: xor n
    source: |
      ld a, 0x7e
      xor 0xe7
      halt
    regs:
      a: 0x99
      f: 0x8c
      pc: 0x0005
  - desc: xor (hl)
    source: |
      ld a, 0x67
      ld hl, 0x0010
      ld (hl), 0x7a
      xor (hl)
      halt
    regs:
      a: 0x1d
      h: 0x00
      l: 0x10
      f: 0x0c
      pc: 0x0009
  - desc: cp r
    source: |
      ld a, 0x63
      ld b, 0x60
      cp b
      halt
    regs:
      a: 0x63
      b: 0x60
      f: 0x02
      pc: 0x0006
  - desc: cp r - sf, yf, hf, xf, nf, cf
    source: |
      ld b, 0x01
      cp b
      halt
    regs:
      a: 0x00
      b: 0x01
      f: 0xbf
      pc: 0x0004
  - desc: cp r - zf, nf
    source: |
      ld b, 0x01
      ld a, 0x01
      cp b
      halt
    regs:
      a: 0x01
      b: 0x01
      f: 0x42
      pc: 0x0006
  - desc: cp n
    source: |
      ld a, 0x10
      cp 0x06
      halt
    regs:
      a: 0x10
      f: 0x1a
      pc: 0x0005
  - desc: cp (hl)
    source: |
      ld hl, 0x1234
      ld (hl), 0x10
      ld a, 0x40
      cp (hl)
      halt
    regs:
      a: 0x40
      h: 0x12
      l: 0x34
      f: 0x22
      pc: 0x0009
  - desc: inc r - yf, xf
    source: |
      ld d, 0x28
      inc d
      halt
    regs:
      d: 0x29
      f: 0x28
      pc: 0x0004
  - desc: inc r - hf
    source: |
      ld a, 0x0f
      inc a
      halt
    regs:
      a: 0x10
      f: 0x10
      pc: 0x0004
  - desc: inc r - sf, hf, pf, cf
    source: |
      ld b, 127
      inc b
      halt
    regs:
      b: 0x80
      f: 0x95
      pc: 0x0004
  - desc: inc r - zf
    source: |
      ld c, 255
      inc c
      halt
    regs:
      c: 0x00
      f: 0x55
      pc: 0x0004
  - desc: inc (hl)
    source: |
      ld hl, 0x0010
      inc (hl)
      halt
    regs:
      h: 0x00
      l: 0x10
      pc: 0x0005
    mem:
      0x0010: 0x01
  - desc: dec r - xf, yf
    source: |
      ld d, 0x2a
      dec d
      halt
    regs:
      d: 0x29
      f: 0x2a
      pc: 0x0004
  - desc: dec r - sf, hf, pf, cf
    source: |
      dec a
      halt
    regs:
      a: 0xff
      f: 0xbf
      pc: 0x0002
  - desc: dec r - zf
    source: |
      ld b, 1
      dec b
      halt
    regs:
      b: 0x00
      f: 0x42
      pc: 0x0004
  - desc: dec (hl)
    source: |
      ld hl, 0x0010
      ld (hl), 2
      dec (hl)
      halt
    regs:
      h: 0x00
      l: 0x10
      f: 0x02
      pc: 0x0007
    mem:
      0x0010: 0x01
  - desc: rlca
    source: |
      ld a, 0x88
      rlca
      halt
    regs:
      a: 0x11
      f: 0x01
      pc: 0x0004
  - desc: ex af
    source: |
      ld a, 0x80
      rlca
      ex af
      ld a, 0xff
      inc a
      halt
    regs:
      a: 0x00
      f: 0x55
      a_alt: 0x01
      f_alt: 0x01
      pc: 0x0008
  - desc: add hl, bc
    source: |
      ld b, 0x10
      ld c, 0x20
      ld h, 0x30
      ld l, 0x40
      add hl, bc
      halt
    regs:
      b: 0x10
      c: 0x20
      h: 0x40
      l: 0x60
      f: 0x00
      pc: 0x000a
  - desc: add hl, bc - overflow
    source: |
      ld bc, 0xffff
      ld hl, 0x0001
      add hl, bc
      halt
    regs:
      b: 0xff
      c: 0xff
      h: 0x00
      l: 0x00
      f: 0x11
      pc: 0x0008
  - desc: inc bc
    source: |
      ld bc, 0x0010
      inc bc
      halt
    regs:
      b: 0x00
      c: 0x11
      f: 0x00
      pc: 0x0005
  - desc: inc bc - overflow
    source: |
      ld bc, 0xffff
      inc bc
      halt
    regs:
      b: 0x00
      c: 0x00
      f: 0x00
      pc: 0x0005
  - desc: inc bc - yf and xf
    source: |
      ld bc, 0x2800
      inc bc
      halt
    regs:
      b: 0x28
      c: 0x01
      f: 0x28
      pc: 0x0005
  - desc: dec bc
    source: |
      ld bc, 0x1010
      dec bc
      halt
    regs:
      b: 0x10
      c: 0x0f
      f: 0x00
      pc: 0x0005
  - desc: dec bc - yf and xf
    source: |
      ld bc, 0x2810
      dec bc
      halt
    regs:
      b: 0x28
      c: 0x0f
      f: 0x28
      pc: 0x0005
  - desc: dec bc - overflow
    source: |
      ld bc, 0x0000
      dec bc
      halt
    regs:
      b: 0xff
      c: 0xff
      f: 0x28
      pc: 0x0005
  - desc: "djnz d - condition false"
    source: |
      ld b, 0x01
      djnz 0x10
      halt
    regs:
      pc: 0x0005
  - desc: "djnz d - condition true"
    source: |
      .org 0x0000
          ; Decrement B register and perform the jump if B != 0.
          ld b, 0x02
          ; Asm decreases d by 2 bytes:
          ;    d = 0x10 - 2 = 0x0e
          ; PC before the jump:
          ;    pc = 2 + 2 = 0x0004 (ld b, n + djnz d)
          ; PC after the jump:
          ;    pc = 0x0004 + d = 0x0004 + 0x0e = 0x0012
          ; PC after executing halt:
          ;    pc = 0x0012 + 1 = 0x0013
          djnz 0x10 ; In LST format 0x10 is replaced by 0x08.
      .org 0x0012
          halt
    regs:
      b: 0x01
      pc: 0x0013
  - desc: rla
    source: |
      ld a, 0x88
      rla
      halt
    regs:
      a: 0x10
      f: 0x01
      pc: 0x0004
  - desc: "rla - CF -> bit 0"
    source: |
      ld a, 0x88
      rla  ; a = 0x10, cf = 1
      rla  ; a = 0x21, cf = 0
      halt
    regs:
      a: 0x21
      f: 0x20
      pc: 0x0005
  - desc: rra
    source: |
      ld a, 0x88
      rra
      halt
    regs:
      a: 0x44
      f: 0x00
      pc: 0x0004

  - desc: rrca
    preset:
      regs:
        a: 0x11
        f: 0x00
    source: |
      rrca
      halt
    regs:
      a: 0x88
      f: 0x09
      pc: 0x0002

  - desc: rrca - yf, xf
    preset:
      regs:
        a: 0x50
    source: |
      rrca
      halt
    regs:
      a: 0x28
      f: 0x28
      pc: 0x0002

  - desc: rra - CF -> bit 7
    source: |
      ld a, 0x22
      rra  ; c = 0, a = 0x11
      rra  ; c = 1, a = 0x88
      halt
    regs:
      a: 0x88
      f: 0x09
      pc: 0x0005

  - desc: rlc r
    preset:
      regs:
        b: 0x88
    source: |
      rlc b
      halt
    regs:
      b: 0x11
      f: 0x05
      pc: 0x0003

  - desc: rlc a - yf, xf
    preset:
      regs:
        a: 0x14
        f: 0x01
    source: |
      rlc a
      halt
    regs:
      a: 0x28
      f: 0x2c
      pc: 0x0003

  - desc: rlc (hl)
    preset:
      regs:
        h: 0x28
        l: 0x28
      mem:
        0x2828: 0x88
    source: |
      rlc (hl)
      halt
    regs:
      h: 0x28
      l: 0x28
      f: 0x05
      pc: 0x0003
    mem:
      0x2828: 0x11

  - desc: rl r - cf -> 0, bit 0 -> 1
    preset:
      regs:
        a: 0x11
        f: 0x01
    source: |
      rl a
      halt
    regs:
      a: 0x23
      f: 0x20
      pc: 0x0003

  - desc: rl r -> cf -> 1, bit 0 -> 0, yf, xf, pvf
    preset:
      regs:
        b: 0x94
    source: |
      rl b
      halt
    regs:
      b: 0x28
      f: 0x2d
      pc: 0x0003

  - desc: rl (hl)
    preset:
      regs:
        h: 0x34
        l: 0x34
      mem:
        0x3434: 0x8f
    source: |
      rl (hl)
      halt
    regs:
      h: 0x34
      l: 0x34
      f: 0x0d
      pc: 0x0003
    mem:
      0x3434: 0x1e

  - desc: rrc r
    preset:
      regs:
        a: 0x31
    source: |
      rrc a
      halt
    regs:
      a: 0x98
      f: 0x89
      pc: 0x0003

  - desc: rrc r - zf, pvf
    preset:
      regs:
        b: 0x00
    source: |
      rrc b
      halt
    regs:
      a: 0x00
      f: 0x44
      pc: 0x0003

  - desc: rrc (hl)
    preset:
      regs:
        h: 0x01
        l: 0x00
      mem:
        0x0100: 0x31
    source: |
      rrc (hl)
      halt
    regs:
      h: 0x01
      f: 0x89
      pc: 0x0003
    mem:
      0x0100: 0x98

  - desc: rr r - sf, yf, pvf
    # skip: due to the assembler error https://github.com/glebzlat/z80asm/issues/2
    preset:
      regs:
        a: 0x40
        f: 0x01
    source: |
      rr a
      halt
    regs:
      f: 0xa4
      a: 0xa0
      pc: 0x0003

  - desc: rr (hl)
    preset:
      regs:
        h: 0x43
        l: 0x43
      mem:
        0x4343: 0xdd
    source: |
      rr (hl)
      halt
    regs:
      h: 0x43
      l: 0x43
      f: 0x29
      pc: 0x0003

  - desc: jr nz, d - condition false
    source: |
      ld a, 0x01
      dec a
      jr nz, 0x10
      halt
    regs:
      a: 0x00
      f: 0x42
      pc: 0x0006

  - desc: jr nz, d - condition true
    source: |
      .org 0x0000
          ld a, 0x00
          inc a  ; a = 0x01, this makes ZF = 0
          jr nz, 0x10
      .org 0x0013
          halt
    regs:
      a: 0x01
      pc: 0x0014

  - desc: "daa - a = 0x00 in (0x00, 0x99), HNC = 000, add 0x00"
    source: |
      ld a, 0x00
      daa
      halt
    regs:
      a: 0x00
      f: 0x44
      pc: 0x0004
  - desc: "daa - a = 0x99 in (0x00, 0x99), HNC = 000, add 0x00"
    source: |
      ld a, 0x99
      daa
      halt
    regs:
      a: 0x99
      f: 0x8c
      pc: 0x0004
  - desc: "daa - a = 0x0a in (0x0a, 0x9f), HNC = 000, add 0x06"
    source: |
      ld a, 0x0a
      daa
      halt
    regs:
      a: 0x10
      f: 0x10
      pc: 0x0004
  - desc: "daa - a = 0x9f in (0x0a, 0x9f), HNC = 000, add 0x66"
    source: |
      ld a, 0x9f
      daa
      halt
    regs:
      a: 0x05
      f: 0x15
      pc: 0x0004

  - desc: cpl
    source: |
      ld a, 0x2a
      cpl
      halt
    regs:
      a: 0xd5
      f: 0x12
      pc: 0x0004

  - desc: cpl - yf, xf
    source: |
      ld a, 0x96
      cpl
      halt
    regs:
      a: 0x69
      f: 0x3a
      pc: 0x0004

  - desc: cpl - n/a sf, pf, cf
    source: |
      dec b
      ld a, 0x28
      cpl
      halt
    regs:
      a: 0xd7
      b: 0xff
      f: 0x97
      pc: 0x0005

  - desc: cpl - n/a zf
    source: |
      ld b, 0x01
      dec b
      ld a, 0xdf
      cpl
      halt
    regs:
      a: 0x20
      b: 0x00
      f: 0x72
      pc: 0x0007

  - desc: neg
    source: |
      ld a, 0x01
      neg
      halt
    regs:
      a: 0xff
      f: 0xbb
      pc: 0x0005

  - desc: neg - zf
    source: |
      ld a, 0x00
      neg
      halt
    regs:
      f: 0x42
      pc: 0x0005

  - desc: neg - pvf
    source: |
      ld a, 0x80
      neg
      halt
    regs:
      a: 0x80
      f: 0x87
      pc: 0x0005

  - desc: ccf
    source: |
      ld a, 0x80
      add a, 0x80  ; a = 0x00, hf = 0, cf = 1
      ccf          ;           hf = 1, cf = 0
      halt
    regs:
      f: 0x54
      pc: 0x0006
  - desc: scf
    source: |
      ld a, 0x10
      sub 0x08     ; a = 0x08, hf = 1, nf = 1, cf = 0
      scf          ;           hf = 0, nf = 0, cf = 1
      halt
    regs:
      a: 0x08
      f: 0x09
      pc: 0x0006
  - desc: ld i, a
    source: |
      ld a, 0x80
      ld i, a
      halt
    regs:
      a: 0x80
      i: 0x80
      pc: 0x0005
  - desc: ld r, a
    source: |
      ld a, 0x2a
      ld r, a
      halt
    regs:
      a: 0x2a
      r: 0x2a
      pc: 0x0005
  - desc: ld dd, (nn); ld (nn), dd
    source: |
      ld de, 0x1234
      ld (0x0010), de
      ld bc, (0x0010)
      halt
    regs:
      b: 0x12
      c: 0x34
      d: 0x12
      e: 0x34
      pc: 0x000c
    mem:
      0x0010: 0x34
      0x0011: 0x12
  - desc: ldi - xf, pvf
    # The LDI/LDIR/LDD/LDDR instructions affect the flags in a strange way. At
    # every iteration, a byte is copied. Take that byte and add the value of
    # register A to it. Call that value n. Now, the flags are:
    #
    #   YF = bit 1 of n
    #   XF = bit 3 of n
    #
    # from The Undocumented Z80 Documented v0.91
    preset:
      regs:
        b: 0x00
        c: 0x07
        d: 0x22
        e: 0x22
        h: 0x11
        l: 0x11
      mem:
        0x1111: 0x88
        0x2222: 0x66
    source: |
      ldi
      halt
    regs:
      b: 0x00
      c: 0x06
      d: 0x22
      e: 0x23
      h: 0x11
      l: 0x12
      f: 0x0c
      pc: 0x0003
    mem:
      0x2222: 0x88
  - desc: ldi - set xf, reset pvf, n/a sf, zf, cf
    preset:
      regs:
        b: 0x00
        c: 0x01
        d: 0x22
        e: 0x22
        h: 0x11
        l: 0x11
        f: 0xc5  # 1100 0101 -> 1100 1001
      mem:
        0x1111: 0x88
        0x2222: 0x55
    source: |
      ldi
      halt
    regs:
      b: 0x00
      c: 0x00
      d: 0x22
      e: 0x23
      h: 0x11
      l: 0x12
      f: 0xc9
      pc: 0x0003
    mem:
      0x2222: 0x88
  - desc: ldi - set yf, reset xf
    # n = a + byte = 0x0a + 0x88 = 0x92
    # yf = bit 1 of 0x92 = 1
    # xf = bit 3 of 0x92 = 0
    # f: 0000 1000 -> 0010 0000
    preset:
      regs:
        a: 0x0a
        b: 0x00
        c: 0x01
        d: 0x22
        e: 0x22
        h: 0x11
        l: 0x11
        f: 0x08
      mem:
        0x1111: 0x88
        0x2222: 0x55
    source: |
      ldi
      halt
    regs:
      a: 0x0a
      b: 0x00
      c: 0x00
      d: 0x22
      e: 0x23
      h: 0x11
      l: 0x12
      f: 0x20
      pc: 0x0003
  - desc: ldir
    preset:
      regs:
        b: 0x00
        c: 0x03
        d: 0x22
        e: 0x22
        h: 0x11
        l: 0x11
      mem:
        0x1111: 0x88
        0x1112: 0x36
        0x1113: 0xa5
        0x2222: 0x66
        0x2223: 0x59
        0x2224: 0xc5
    source: |
      ldir
      halt
    regs:
      b: 0x00
      c: 0x00
      d: 0x22
      e: 0x25
      h: 0x11
      l: 0x14
      pc: 0x0003
    mem:
      0x2222: 0x88
      0x2223: 0x36
      0x2224: 0xa5
  - desc: ldd - xf, pvf
    preset:
      regs:
        b: 0x00
        c: 0x07
        d: 0x22
        e: 0x22
        h: 0x11
        l: 0x11
      mem:
        0x1111: 0x88
        0x2222: 0x55
    source: |
      ldd
      halt
    regs:
      b: 0x00
      c: 0x06
      d: 0x22
      e: 0x21
      h: 0x11
      l: 0x10
      f: 0x0c
      pc: 0x0003
    mem:
      0x2222: 0x88

  - desc: lddr
    preset:
      regs:
        b: 0x00
        c: 0x03
        d: 0x22
        e: 0x25
        h: 0x11
        l: 0x14
      mem:
        0x1112: 0x88
        0x1113: 0x36
        0x1114: 0xa5
        0x2223: 0x66
        0x2224: 0x59
        0x2225: 0xc5
    source: |
      lddr
      halt
    regs:
      b: 0x00
      c: 0x00
      d: 0x22
      e: 0x22
      h: 0x11
      l: 0x11
      f: 0x08
      pc: 0x0003
    mem:
      0x2223: 0x88
      0x2224: 0x36
      0x2225: 0xa5

  - desc: cpi
    # CPI/CPIR/CRD/CPDR instructions compare a series of bytes in memory to
    # register A. Effectively, it can be said it does CP (HL) at every
    # iteration. The result of that compare sets the HF flag. So,
    # n = A - (HL) - HF.
    #
    #   SF, ZF, HF set by the hypothetical CP (HL)
    #   YF = bit 1 of n
    #   XF = bit 3 of n
    #   PF = BC is not 0
    #   NF = 1
    #
    # from The Undocumented Z80 Documented v0.91
    preset:
      regs:
        a: 0x3b
        b: 0x00
        c: 0x01
        h: 0x11
        l: 0x11
      mem:
        0x1111: 0x3b
    source: |
      cpi
      halt
    regs:
      a: 0x3b
      b: 0x00
      c: 0x00
      h: 0x11
      l: 0x12
      f: 0x42
      pc: 0x0003

  - desc: cpi - sf, hf, yf, xf, pf
    preset:
      regs:
        a: 0x00
        b: 0x00
        c: 0x02
        h: 0x00
        l: 0x10
      mem:
        0x0010: 0x01
    source: |
      cpi
      halt
    regs:
      a: 0x00
      b: 0x00
      c: 0x01
      h: 0x00
      l: 0x11
      f: 0xbe
      pc: 0x0003

  - desc: cpir
    preset:
      regs:
        a: 0xf3
        b: 0x00
        c: 0x07
        h: 0x11
        l: 0x11
      mem:
        0x1111: 0x52
        0x1112: 0x22
        0x1113: 0xf3
    source: |
      cpir
      halt
    regs:
      a: 0xf3
      b: 0x00
      c: 0x04
      h: 0x11
      l: 0x14
      f: 0x46
      pc: 0x0003

  - desc: cpd - zf
    preset:
      regs:
        a: 0x3b
        b: 0x00
        c: 0x01
        h: 0x11
        l: 0x11
      mem:
        0x1111: 0x3b
    source: |
      cpd
      halt
    regs:
      a: 0x3b
      b: 0x00
      c: 0x00
      h: 0x11
      l: 0x10
      f: 0x42
      pc: 0x0003

  - desc: cpd - hf
    preset:
      regs:
        a: 0x10
        b: 0x00
        c: 0x01
        h: 0x00
        l: 0x10
      mem:
        0x0010: 0x0f
    source: |
      cpd
      halt
    regs:
      a: 0x10
      b: 0x00
      c: 0x00
      h: 0x00
      l: 0x0f
      f: 0x12
      pc: 0x0003

  - desc: cpd - yf, hf, xf
    preset:
      regs:
        a: 0x10
        b: 0x00
        c: 0x01
        h: 0x00
        l: 0x10
      mem:
        0x0010: 0x01
    source: |
      cpd
      halt
    regs:
      a: 0x10
      b: 0x00
      c: 0x00
      h: 0x00
      l: 0x0f
      f: 0x3a
      pc: 0x0003

  - desc: cpd - zf, pvf
    preset:
      regs:
        a: 0x01
        b: 0x00
        c: 0x02
        h: 0x00
        l: 0x10
      mem:
        0x0010: 0x01
    source: |
      cpd
      halt
    regs:
      a: 0x01
      b: 0x00
      c: 0x01
      h: 0x00
      l: 0x0f
      f: 0x46
      pc: 0x0003

  - desc: cpdr
    preset:
      regs:
        a: 0xf3
        b: 0x00
        c: 0x07
        h: 0x11
        l: 0x18
      mem:
        0x1116: 0xf3
        0x1117: 0x00
        0x1118: 0x52
    source: |
      cpdr
      halt
    regs:
      a: 0xf3
      b: 0x00
      c: 0x04
      h: 0x11
      l: 0x15
      f: 0x46
      pc: 0x0003

  - desc: push rr
    source: |
      ld sp, 0x1000
      ld hl, 0x1234
      push hl
      halt
    regs:
      h: 0x12
      l: 0x34
      sp: 0xffe
      pc: 0x0008
    mem:
      0xfff: 0x12
      0xffe: 0x34

  - desc: push iz
    preset:
      regs:
        ix: 0x3576
        iy: 0x1977
        sp: 0x0104
    source: |
      push ix
      push iy
      halt
    regs:
      ix: 0x3576
      iy: 0x1977
      sp: 0x0100
      pc: 0x0005
    mem:
      0x0103: 0x35
      0x0102: 0x76
      0x0101: 0x19
      0x0100: 0x77

  - desc: pop rr
    source: |
      ld sp, 0x1000
      ld de, 0x1234
      push de
      pop hl
      halt
    regs:
      d: 0x12
      e: 0x34
      h: 0x12
      l: 0x34
      sp: 0x1000
      pc: 0x0009
    mem:
      0xfff: 0x12
      0xffe: 0x34

  - desc: pop iz
    preset:
      regs:
        sp: 0x1000
      mem:
        0x1000: 0x55
        0x1001: 0x33
        0x1002: 0x44
        0x1003: 0x22
    source: |
      pop ix
      pop iy
      halt
    regs:
      ix: 0x3355
      iy: 0x2244
      sp: 0x1004
      pc: 0x0005

  - desc: jp nn
    source: |
      .org 0x0000
          jp 0x0100
      .org 0x0100
          halt
    regs:
      pc: 0x0101

  - desc: jp nz = true
    preset:
      regs:
        f: 0x00
    source: |
      .org 0x0000
          jp nz, 0x0100
      .org 0x0100
          halt
    regs:
      pc: 0x0101

  - desc: jp nz = false
    preset:
      regs:
        f: 0x40
    source: |
      .org 0x0000
          jp nz, 0x0100
          halt
      .org 0x0100
          halt
    regs:
      f: 0x40
      pc: 0x0004

  - desc: jp nc = true
    preset:
      regs:
        f: 0x00
    source: |
      .org 0x0000
          jp nc, 0x0100
      .org 0x0100
          halt
    regs:
      pc: 0x0101

  - desc: jp nc = false
    preset:
      regs:
        f: 0x01
    source: |
      .org 0x0000
          jp nc, 0x0100
          halt
      .org 0x0100
          halt
    regs:
      f: 0x01
      pc: 0x0004

  - desc: jp p
    preset:
      regs:
        f: 0x00
    source: |
      .org 0x0000
          jp p, 0x0100
      .org 0x0100
          halt
    regs:
      pc: 0x0101

  - desc: not jp p
    preset:
      regs:
        f: 0x80
    source: |
      .org 0x0000
          jp p, 0x0100
          halt
      .org 0x0100
          halt
    regs:
      f: 0x80
      pc: 0x0004

  - desc: jp m
    preset:
      regs:
        f: 0x80
    source: |
      .org 0x0000
          jp m, 0x0100
      .org 0x0100
          halt
    regs:
      f: 0x80
      pc: 0x0101

  - desc: jr e - positive
    source: |
      .org 0x0000
          jr 0x10
          ld a, 0x10
      .org 0x0010
          ld a, 0x20
          halt
    regs:
      a: 0x20
      pc: 0x0013

  - desc: jr e - negative
    source: |
      .org 0x0000
          jr 0x20
      .org 0x0010
          ld a, 0x20
          halt
      .org 0x0020
          jr -0x10
    regs:
      a: 0x20
      pc: 0x0013

  - desc: jr c, e
    preset:
      regs:
        f: 0x01
        pc: 0x0480
    source: |
      .org 0x047c
          halt
      .org 0x0480
          jr c, -4
    regs:
      f: 0x01
      pc: 0x047d

  - desc: djnz e
    source: |
      .org 0x0010
      start:
          ld b, 20       ; set up counter
          ld hl, input   ; set up input buffer pointer
          ld de, output  ; set up output buffer pointer
      loop:
          ld a, (hl)     ; get next byte from input buffer
          ld (de), a     ; store in output buffer
          cp '\0'        ; is it a null terminator?
          jr z, done     ; yes -> finished
          inc hl         ; increment pointers
          inc de
          djnz loop      ; loop back if n bytes < 80
      done:
          halt
      .org 0x0100
      input:
      .db "Hello world\0"
      .org 0x0200
      output:
    regs:
      b: 0x09
      d: 0x02
      e: 0x0b
      f: 0x42
      h: 0x01
      l: 0x0b
      pc: 0x0023
    mem:
      0x0200: 72  # 'H'
      0x0201: 101 # 'e'
      0x0202: 108 # 'l'
      0x0203: 108 # 'l'
      0x0204: 111 # 'o'
      0x0205: 32  # ' '
      0x0206: 119 # 'w'
      0x0207: 111 # 'o'
      0x0208: 114 # 'r'
      0x0209: 108 # 'l'
      0x020a: 100 # 'd'
      0x020b: 0
